<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Missions | The Organization</title>
    <link rel="icon" type="image/png" href="icon.png">
    <link rel="stylesheet" href="style.css">
    <script defer src="menu.js"></script>
    <style>
        /* Minimal, local styles for mission widgets without altering global CSS */
        .missions-grid { display: grid; gap: 1rem; max-width: 1000px; margin: 0 auto; }
        @media (min-width: 900px){ .missions-grid { grid-template-columns: 1fr 1fr; } }
        .mission { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,0,0,0.2); border-radius: 8px; padding: 1rem; }
        .mission h3 { margin: 0 0 0.25rem 0; color: var(--color-accent-dark); }
        .mission small { color: rgba(255,255,255,0.6); }
        .mission .controls { display: flex; gap: 0.5rem; align-items: center; margin-top: 0.5rem; flex-wrap: wrap; }
        .mission .status { font-weight: bold; color: var(--color-accent-dark); }
        .mission .complete { color: #7CFC00; }
        .mission .failed { color: #ff5c5c; }
        .mission .code-row { display: flex; gap: 0.5rem; margin-top: 0.5rem; align-items: center; flex-wrap: wrap; }
        .mission input.mcode { width: 6.2rem; text-align: center; padding: 0.5rem 0.6rem; font-size: 1.05rem; border-radius: 6px; border: 1px solid rgba(255,0,0,0.28); background: rgba(255,255,255,0.06); color: #f2f2f2; }
        .mission input.mcode::placeholder { color: rgba(255,255,255,0.45); }
        .mission button.verify { background: linear-gradient(180deg, rgba(255,0,0,0.18), rgba(255,0,0,0.12)); color: #fff; border: 1px solid rgba(255,0,0,0.45); padding: 0.5rem 0.8rem; border-radius: 6px; cursor: pointer; text-shadow: 0 0 6px rgba(255,0,0,0.35); }
        .mission button.verify:hover { background: rgba(255,0,0,0.25); }
        .btn { background: rgba(255,255,255,0.06); color: #fff; border: 1px solid rgba(255,255,255,0.18); padding: 0.45rem 0.8rem; border-radius: 6px; cursor: pointer; }
        .btn:hover { background: rgba(255,255,255,0.12); }
        a.btn-link { display: inline-block; text-decoration: none; background: rgba(255,255,255,0.06); color: #fff; border: 1px solid rgba(255,255,255,0.18); padding: 0.45rem 0.8rem; border-radius: 6px; }
        a.btn-link:hover { background: rgba(255,255,255,0.12); }
        .hint { color: rgba(255,255,255,0.65); font-size: 0.95rem; }
        .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }
        .block { background: rgba(0,0,0,0.35); padding: 0.5rem 0.7rem; border-radius: 6px; border: 1px solid rgba(255,255,255,0.08); }
        .pill { display: inline-block; padding: 0.2rem 0.5rem; border-radius: 999px; background: rgba(255,0,0,0.12); border: 1px solid rgba(255,0,0,0.25); }
        .center { text-align: center; }
        .hidden { display: none; }
        
    </style>
    <script>
        // Mission configuration (adjust codes if needed before the event)
        const MISSION_CONFIG = {
            m1: { title: 'Excavation Directive', code: '5728' },
            m2: { title: 'Payload Conversion', code: '2905' },
            m3: { title: 'Lights Out', code: '3140' }, // Lights Out (separate page)
            m4: { title: 'Sequence Lock', code: '6820' }, // Simon-like (separate page)
            m5: { title: 'Signal Decode', code: '1138' }, // Binary -> ASCII
            m6: { title: 'Unknown Channel', code: '4411' }, // Chat (separate page)
        };

        const LS_KEY = 'org_missions_state_v1';
        function getState() {
            try { return JSON.parse(localStorage.getItem(LS_KEY)) || {}; } catch { return {}; }
        }
        function setState(s) {
            localStorage.setItem(LS_KEY, JSON.stringify(s));
        }
        function markComplete(id, code) {
            const state = getState();
            state[id] = { completed: true, code };
            setState(state);
            const root = document.querySelector(`[data-mission="${id}"]`);
            if (!root) return;
            root.querySelector('.status').textContent = 'Completed';
            root.querySelector('.status').classList.add('complete');
            const input = root.querySelector('input.mcode');
            if (input) input.value = code;
            root.querySelectorAll('input, button').forEach(el => {
                if (el.classList.contains('menu-toggle')) return; // keep toggles usable
                el.disabled = true;
            });
            const reveal = root.querySelector('.reveal');
            if (reveal) reveal.classList.remove('hidden');
            updateSummary();
        }
        function updateSummary(){
            const state = getState();
            let done = 0, total = 0;
            for (const id in MISSION_CONFIG) {
                total++;
                if (state[id]?.completed) done++;
            }
            const el = document.getElementById('mission-progress');
            if (el) el.textContent = `${done} / ${total} complete`;
        }
        function attachVerifyHandlers(){
            document.querySelectorAll('[data-mission]').forEach(root => {
                const id = root.getAttribute('data-mission');
                const expected = MISSION_CONFIG[id].code;
                const input = root.querySelector('input.mcode');
                const btn = root.querySelector('button.verify');
                if (!btn) return;
                btn.addEventListener('click', () => {
                    const v = (input.value || '').trim();
                    if (/^\d{4}$/.test(v) && v === expected) {
                        markComplete(id, v);
                    } else {
                        const msg = root.querySelector('.result');
                        msg.textContent = 'Invalid or incomplete. Recheck your work.';
                        msg.classList.add('failed');
                        setTimeout(() => msg.classList.remove('failed'), 1000);
                    }
                });
                input.addEventListener('input', () => {
                    input.value = input.value.replace(/[^0-9]/g, '').slice(0,4);
                });
            });
        }

        // Encoded download (m2)
        function setupDownload(){
            const btn = document.getElementById('payload-download');
            if (!btn) return;
            const payload = 'GRIDLINE//PAYLOAD\nnumber: 2905\nack: ok\n';
            const b64 = btoa(payload);
            btn.addEventListener('click', () => {
                const blob = new Blob([b64], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'payload.dat';
                document.body.appendChild(a);
                a.click();
                a.remove();
                setTimeout(() => URL.revokeObjectURL(url), 1000);
            });
        }

        // Binary decode mission (m5)
        function setupBinary(){
            const el = document.getElementById('bin-seq');
            if (!el) return;
            // 1138 => ASCII: 49 49 51 56 => binary groups below
            el.textContent = '00110001 00110001 00110011 00111000';
        }


        document.addEventListener('DOMContentLoaded', ()=>{
            // Restore state
            const state = getState();
            for (const id in state){ if (state[id]?.completed) markComplete(id, state[id].code); }
            updateSummary();
            attachVerifyHandlers();
            setupDownload();
            setupBinary();
        });
    </script>
</head>

<body>
    <nav>
        <a href="index.html">Home</a>
    </nav>

    <main>
        <h1>Missions</h1>
        <p class="hint">These are assignments issued by The Organization. Completion is mandatory. Each successful action yields a four digit number. Keep those secured.</p>
        <p class="pill" id="mission-progress">0 / 6 complete</p>

        <div class="missions-grid">

            <!-- M1 Excavation -->
            <section class="mission" data-mission="m1">
                <h3>Mission 1: Excavation Directive</h3>
                <small>Status: <span class="status">Incomplete</span></small>
                <p class="hint">Brief: Recover the strip from the yard. Do not broadcast.</p>
                <button class="menu-toggle base" style="margin-top:0.5rem;">Accept Mission</button>
                <ul class="menu">
                    <li>
                        <p>Retrieve a sealed strip from 626 Armstead Street Azusa California. Look for the eye mark.</p>
                        <p class="hint">Placement: beneath a marked stone near the front steps.</p>
                        <p>Insert the four digits from the strip.</p>
                    </li>
                </ul>
                <div class="code-row">
                    <input class="mcode mono" inputmode="numeric" placeholder="4 digits" maxlength="4">
                    <button class="verify">Submit Code</button>
                    <span class="result mono"></span>
                </div>
                <div class="reveal hint hidden">Recorded.</div>
            </section>

            <!-- M2 Encoded download -->
            <section class="mission" data-mission="m2">
                <h3>Mission 2: Payload Conversion</h3>
                <small>Status: <span class="status">Incomplete</span></small>
                <p class="hint">Brief: Acquire the payload and extract the line.</p>
                <button class="menu-toggle base" style="margin-top:0.5rem;">Accept Mission</button>
                <ul class="menu">
                    <li>
                        <p>Download the payload file below. Recover the four digit line contained within.</p>
                        <div class="controls"><button id="payload-download" class="btn">Download Payload</button></div>
                    </li>
                </ul>
                <div class="code-row">
                    <input class="mcode mono" inputmode="numeric" placeholder="4 digits" maxlength="4">
                    <button class="verify">Submit Code</button>
                    <span class="result mono"></span>
                </div>
                <div class="reveal hint hidden">Recorded.</div>
            </section>

            <!-- M3 Lights Out -->
            <section class="mission" data-mission="m3">
                <h3>Mission 3: Lights Out</h3>
                <small>Status: <span class="status">Incomplete</span></small>
                <p class="hint">Brief: Power down the grid. When the field clears, the line appears.</p>
                <button class="menu-toggle base" style="margin-top:0.5rem;">Accept Mission</button>
                <ul class="menu">
                    <li>
                        <p>Open the puzzle and solve the grid. When complete, record the four digits shown.</p>
                        <p><a href="lightsout.html" class="btn-link">Open Lights Out</a></p>
                    </li>
                </ul>
                <div class="code-row">
                    <input class="mcode mono" inputmode="numeric" placeholder="4 digits" maxlength="4">
                    <button class="verify">Submit Code</button>
                    <span class="result mono"></span>
                </div>
                <div class="reveal hint hidden">Recorded.</div>
            </section>

            <!-- M4 Sequence lock -->
            <section class="mission" data-mission="m4">
                <h3>Mission 4: Sequence Lock</h3>
                <small>Status: <span class="status">Incomplete</span></small>
                <p class="hint">Brief: Calibrate to the lockâ€™s pattern.</p>
                <button class="menu-toggle base" style="margin-top:0.5rem;">Accept Mission</button>
                <ul class="menu">
                    <li>
                        <p>Open the lock interface and repeat the sequence until the channel releases the four digits.</p>
                        <p><a href="sequence.html" class="btn-link">Open Sequence Lock</a></p>
                    </li>
                </ul>
                <div class="code-row">
                    <input class="mcode mono" inputmode="numeric" placeholder="4 digits" maxlength="4">
                    <button class="verify">Submit Code</button>
                    <span class="result mono"></span>
                </div>
                <div class="reveal hint hidden">Recorded.</div>
            </section>

            <!-- M5 Binary decode -->
            <section class="mission" data-mission="m5">
                <h3>Mission 5: Signal Decode</h3>
                <small>Status: <span class="status">Incomplete</span></small>
                <p class="hint">Brief: Intercepted signal fragment. Recover the digits.</p>
                <button class="menu-toggle base" style="margin-top:0.5rem;">Accept Mission</button>
                <ul class="menu">
                    <li>
                        <p class="mono" id="bin-seq"></p>
                    </li>
                </ul>
                <div class="code-row">
                    <input class="mcode mono" inputmode="numeric" placeholder="4 digits" maxlength="4">
                    <button class="verify">Submit Code</button>
                    <span class="result mono"></span>
                </div>
                <div class="reveal hint hidden">Recorded.</div>
            </section>

            <!-- M6 Chat with unknown (Nivlac) -->
            <section class="mission" data-mission="m6">
                <h3>Mission 6: Unknown Channel</h3>
                <small>Status: <span class="status">Incomplete</span></small>
                <p class="hint">Brief: Open a masked channel and obtain the key.</p>
                <button class="menu-toggle base" style="margin-top:0.5rem;">Accept Mission</button>
                <ul class="menu">
                    <li>
                        <p>Establish a secure text channel and convince the operator to release the four digit key.</p>
                        <p><a href="unknown.html" class="btn-link">Open Channel</a></p>
                    </li>
                </ul>
                <div class="code-row">
                    <input class="mcode mono" inputmode="numeric" placeholder="4 digits" maxlength="4">
                    <button class="verify">Submit Code</button>
                    <span class="result mono"></span>
                </div>
                <div class="reveal hint hidden">Recorded.</div>
            </section>

        </div>

        <section style="margin-top:1.25rem;">
            <p class="hint">Note: Completed missions persist on this device. When the work is complete, proceed to Internal Access.</p>
        </section>
    </main>

    <img src="icon.png" class="icon" style="top:28%; left:10%;">
    <img src="icon.png" class="icon" style="bottom:15%; right:14%;">
</body>

</html>
