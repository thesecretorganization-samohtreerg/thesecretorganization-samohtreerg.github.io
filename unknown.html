<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Unknown Channel | The Organization</title>
  <link rel="icon" type="image/png" href="icon.png">
  <link rel="stylesheet" href="style.css">
  <style>
    .wrap { max-width: 780px; margin: 0 auto; padding: 1rem; }
    .panel { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,0,0,0.2); border-radius: 8px; padding: 0.8rem; }
    .controls { display: flex; gap: 0.5rem; flex-wrap: wrap; align-items: center; margin-bottom: 0.6rem; }
    button.btn { background: rgba(255,255,255,0.06); color: #fff; border: 1px solid rgba(255,255,255,0.18); padding: 0.45rem 0.8rem; border-radius: 6px; cursor: pointer; }
    button.btn:hover { background: rgba(255,255,255,0.12); }
    .chat { height: 320px; overflow: auto; background: rgba(0,0,0,0.35); border: 1px solid rgba(255,255,255,0.15); border-radius: 6px; padding: 0.6rem; }
    .row { display: flex; gap: 0.5rem; margin-top: 0.5rem; }
    .row input { flex: 1; padding: 0.45rem 0.6rem; border-radius: 6px; border: 1px solid rgba(255,255,255,0.18); background: rgba(255,255,255,0.06); color: #f2f2f2; }
    .msg { margin: 0.25rem 0; }
    .you { color: #9cdcfe; }
    .them { color: #ffa07a; }
    .sys { color: #c0c0c0; font-style: italic; }
    .bar { height: 8px; background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.18); border-radius: 6px; overflow: hidden; }
    .bar > span { display: block; height: 100%; width: 100%; background: linear-gradient(90deg, rgba(255,0,0,0.35), rgba(255,0,0,0.8)); transition: width 0.25s ease; }
    .hint { color: rgba(255,255,255,0.65); }
  </style>
</head>
<body>
  <nav>
    <a href="missions.html">Back to Missions</a>
  </nav>
  <main class="wrap">
    <h1>Unknown Channel</h1>

    <section class="panel">
      <div class="controls">
                <span id="conn" class="hint">Connecting...</span>
        <button id="scramble" class="btn" style="display:none;">Scramble User ID</button>
      </div>
      <div class="hint" style="margin-bottom:0.25rem;">Messages remaining: <span id="left">10</span>/10</div>
      <div class="bar"><span id="dataBar"></span></div>
      <div id="log" class="chat" style="margin-top:0.6rem;"></div>
      <div class="row"><input id="inp" placeholder="Message" maxlength="40" disabled/><button id="send" class="btn" disabled>Send</button></div>
      <p class="hint" style="margin-top:0.5rem;">Maintain control of the exchange. Recover the mission code.</p>
    </section>
  </main>
  <script>
    // Config: include API key here (temporary project)
    const OPENAI_API_KEY = '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';
    const MODEL = 'gpt-5-nano';
    const PROMPT_ID = 'pmpt_6911233f7bb88197894848bfb4305eef073c39e11439c848';

    // UI refs
    const log = document.getElementById('log');
    const inp = document.getElementById('inp');
    const send = document.getElementById('send');
    const scrambleBtn = document.getElementById('scramble');
    const dataBar = document.getElementById('dataBar');
    const connEl = document.getElementById('conn');
    const leftEl = document.getElementById('left');

    const MAX_MSGS = 10; // user messages per session
    let remaining = MAX_MSGS;
    let connected = false;
    let conversationId;

    function setRemaining(n){ remaining = Math.max(0, Math.min(MAX_MSGS, n)); const pct = (remaining / MAX_MSGS) * 100; dataBar.style.width = pct + '%'; leftEl.textContent = String(remaining); }
    function add(cls, text){ const d=document.createElement('div'); d.className='msg '+cls; d.textContent=text; log.appendChild(d); log.scrollTop = log.scrollHeight; }
    function them(t){ add('them', t); }
    function you(t){ add('you', t); }
    function sys(t){ add('sys', t); }

    // System prompt removed from source â€” using PROMPT_ID via Responses API

    function startSession(){
      if (!OPENAI_API_KEY) { connEl.textContent = 'Disconnected from server'; sys('No connection.'); return; }
      connected = true; setRemaining(MAX_MSGS);
      log.innerHTML = '';
      sys('Channel masked. Routing unknown.');
      them('Identify.');
      inp.disabled = false; send.disabled = false; scrambleBtn.style.display='inline-block'; connEl.textContent = 'Connected';
    }

    function endSession(scrambleNote=true){
      connected = false; inp.disabled = true; send.disabled = true; scrambleBtn.style.display='none'; connEl.textContent = OPENAI_API_KEY ? 'Ready' : 'Disconnected from server';
      if (scrambleNote) sys('Connection terminated. User id scrambled.');
      setRemaining(MAX_MSGS);
    }

    async function callModel(prompt){
      try {
        // Responses API with stored Prompt ID and conversation memory
        const body = { model: MODEL, input: [{ role: 'user', content: String(prompt) }]/*, prompt: { id: PROMPT_ID, version: 1 }*/ };
        if (typeof conversationId === 'string') body.conversation = conversationId;

        const res = await fetch('https://api.openai.com/v1/responses', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + OPENAI_API_KEY },
          body: JSON.stringify(body)
        });
        if (res.ok) {
          console.log(res);
          const data = await res.json();
          if (data?.conversation?.id) conversationId = data.conversation.id; // TODO: Sanitize
          else if (data?.conversation_id) conversationId = data.conversation_id;
          const text = (data?.output_text || data?.output?.[0]?.content?.[0]?.text || '').trim();
          if (text) return text;
        }
      } catch (e) {
        return null;
      }
    }

    async function sendUser(){
      if (!connected) return;
      const t = inp.value.trim(); if (!t) return;
      if (remaining <= 0) { sys('Data exhausted. Scramble ID to try again.'); return; }
      inp.value=''; you(t); setRemaining(remaining-1);
      let reply = await callModel(t);
      if (!reply) { sys('Disconnected from server.'); return; }
      them(reply);
      // Allow Nivlac to terminate via message content
      const lower = reply.toLowerCase();
      if (lower === 'connection terminated') {
        endSession(false);
      }
    }

    // Wire UI
    // Auto-connect on load
    window.addEventListener('DOMContentLoaded', startSession);
    // Scramble button resets the session
    scrambleBtn.addEventListener('click', ()=>{ endSession(true); startSession(); });
    send.addEventListener('click', sendUser);
    inp.addEventListener('keydown', e=>{ if(e.key==='Enter') send.click(); });

    // Initialize
    setRemaining(MAX_MSGS);
    connEl.textContent = OPENAI_API_KEY ? 'Ready' : 'Disconnected from server';
  </script>
</body>
</html>
